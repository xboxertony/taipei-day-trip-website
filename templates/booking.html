{% extends "model.html" %} {% block style%}
<script src="https://js.tappaysdk.com/tpdirect/v5.5.0"></script>
<style>
  .order_page > div:not(:last-of-type) {
    border-bottom: 1px solid #e8e8e8;
  }
  .schedule {
    width: 60%;
    margin: auto;
    box-sizing: border-box;
  }
  .schedule.close ~ div {
    display: none;
  }
  .schedule > p {
    padding: 20px 0;
    box-sizing: border-box;
  }
  .checkout {
    display: flex;
    width: 100%;
    margin: 10px 0;
    position: relative;
  }
  .photo,
  .word_to_paid {
    height: 200px;
  }
  .checkout > .delete {
    position: absolute;
    left: 100%;
    transform: translateX(-100%);
    cursor: pointer;
  }
  .photo {
    width: 266px;
    margin-right: 22px;
  }
  .photo img {
    width: 100%;
  }
  .title_word_to_paid {
    color: #448899;
    font-weight: 700;
  }
  .information {
    color: #666666;
    font-weight: 700;
  }
  .form_div {
    width: 60%;
    margin: auto;
    padding: 20px 0;
    box-sizing: border-box;
  }
  .form_style {
    display: flex;
    flex-direction: column;
  }
  .form_style p {
    color: #666666;
    font-weight: 700;
  }
  .form_style input {
    padding: 5px;
  }
  .form_style p,
  .form_style div {
    margin: 10px 0;
  }
  .ready_to_paid .summary {
    float: right;
  }
  .summary p,
  .summary button {
    margin: 25px 0;
  }
  .summary p {
    text-align: right;
  }
  .ready_to_paid .clear {
    clear: both;
  }
  .word_to_paid {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .card {
    width: calc(162px / 4);
  }
  .time {
    width: calc(162px / 2);
  }
  #total_sum {
    font-weight: 900;
  }
  .credit_card_panel {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    width: 340px;
  }
  .credit_card_panel p:first-child {
    color: #666666;
    font-weight: 700;
  }
  /* .credit_card_panel button{
    width: auto;
    height: auto;
  } */
  .tpfield {
    width: 200px;
    height: 25px;
    border: 1px solid gray;
    margin: 5px 0;
    padding: 5px;
  }
  .order_credit_card {
    display: flex;
    margin: 10px 0;
    align-items: center;
  }
  @media screen and (max-width: 800px) {
    .form_div,
    .schedule {
      width: 90%;
      display: flex;
      flex-direction: column;
      margin: auto;
      align-items: center;
    }
    .checkout {
      width: 340px;
      flex-direction: column;
    }
    .word_to_paid {
      width: 100%;
      justify-content: space-evenly;
    }
    .photo {
      width: 100%;
      height: auto;
      margin: auto;
    }
    .summary form {
      text-align: right;
    }
    .form_style {
      width: 340px;
    }
    .checkout .delete {
      top: 100%;
      transform: translate(-100%, -100%);
    }
  }
</style>
{% endblock %} {% block content %}
<div class="order_page">
  <div class="schedule">
    <p id="howareyou">您好，Yahoo，你待確認的行程如下</p>
    <!-- <div class="checkout">
      <div class="photo"></div>
      <div class="word_to_paid">
        <p class="title_word_to_paid">台北一日遊1</p>
        <p class="information">日期：</p>
        <p class="information">時間：</p>
        <p class="information">費用：</p>
        <p class="information">地點：</p>
      </div>
      <img src="../static/icon_delete.png" alt="" class="delete">
    </div> -->
  </div>
  <div class="contact form_div">
    <form action="" class="form_style">
      <p>你的連絡資訊</p>
      <div>
        <label for="">聯絡姓名：</label
        ><input type="text" placeholder="ex:Yakoo" id="order_name" />
      </div>
      <div>
        <label for="">聯絡信箱：</label
        ><input
          type="text"
          placeholder="ex:imyeeee@gmail.com"
          id="order_email"
        />
      </div>
      <div>
        <label for="">手機號碼：</label><input type="text" id="order_phone" />
      </div>
      <p>
        請保持手機暢通，準時到達，導覽人員將用手機與您聯繫，務必留下正確的聯絡方式
      </p>
    </form>
  </div>
  <div class="paid form_div">
    <div class="credit_card_panel">
      <p>信用卡付款資訊</p>
      <div class="order_credit_card">
        <label for="card-number">卡片號碼：</label>
        <div class="tpfield" id="card-number"></div>
      </div>
      <div class="order_credit_card">
        <label for="card-expiration-date">過期時間：</label>
        <div class="tpfield" id="card-expiration-date"></div>
      </div>
      <div class="order_credit_card">
        <label for="card-ccv">驗證密碼：</label>
        <div class="tpfield" id="card-ccv"></div>
      </div>
      <!-- <button id="submit-button" onclick="onClick()">Get Prime</button>
      <button id="xxx" onclick="search()">search</button> -->
    </div>
    <!-- <form action="" class="form_style">
      <p>信用卡付款資訊</p>
      <div>
        <label for="">卡片號碼：</label>
        <input
          type="text"
          class="card"
          id="C1"
          maxlength="4"
          onKeyup="NextMove(this,'C2')"
        />
        -
        <input
          type="text"
          class="card"
          id="C2"
          maxlength="4"
          onKeyup="NextMove(this,'C3')"
        />
        -
        <input
          type="text"
          class="card"
          id="C3"
          maxlength="4"
          onKeyup="NextMove(this,'C4')"
        />
        -
        <input type="text" class="card" id="C4" maxlength="4" />
      </div>
      <div>
        <label for="">過期時間：</label>
        <input
          type="text"
          maxlength="2"
          id="T1"
          class="time"
          onKeyup="NextMove(this,'T2')"
        />
        /
        <input type="text" maxlength="2" class="time" id="T2" />
      </div>
      <div>
        <label for="">驗證密碼：</label>
        <input type="text" />
      </div>
    </form> -->
  </div>
  <div class="ready_to_paid form_div">
    <div class="summary">
      <p id="total_sum">確認總價：新台幣2000元</p>
      <button id="confirm_order_btn" onclick="onClick()">確認訂購並付款</button>
      <p id="status_code"></p>
    </div>
    <div class="clear"></div>
  </div>
</div>
{% endblock %} {% block script %}
<script>
  let confirm_btn = document.getElementById("confirm_order_btn");
  let attraction_order = {};

  // function NextMove(obj, Nextone) {
  //   let Next = document.getElementById(Nextone);
  //   if (obj.value.length === parseInt(obj.getAttribute("maxlength"))) {
  //     Next.focus();
  //   }
  //   return;
  // }

  function evoke_delete_fcn() {
    let delete_fuc = document.getElementsByClassName("delete");

    Array.from(delete_fuc).forEach((element) => {
      element.addEventListener("click", (e) => {
        e.target.parentNode.remove();
        fetch("/api/booking", {
          method: "DELETE",
        })
          .then((res) => {
            return res.json();
          })
          .then((d) => {
            delete_below();
          });
      });
    });
  }

  let schedule = document.getElementsByClassName("schedule")[0];

  fetch("/api/booking", {
    method: "GET",
  })
    .then((res) => {
      return res.json();
    })
    .then((d) => {
      append_attraction(d);
      evoke_delete_fcn();
    });

  fetch("/api/user", {
    method: "GET",
  })
    .then((res) => {
      return res.json();
    })
    .then((data) => {
      document.getElementById(
        "howareyou"
      ).innerHTML = `您好，${data.data.name}，您待預定的行程如下`;
    });

  function delete_below() {
    let text = document.createElement("p");
    text.innerHTML = "目前沒有任何待預定的行程";
    schedule.appendChild(text);

    schedule.classList.add("close");
  }

  function append_attraction(d) {
    if (!d.data) {
      delete_below();
      return;
    }
    let order_image = document.createElement("div");
    order_image.classList.add("photo");
    let image_inside = new Image();
    image_inside.src = d.data.attraction.image;
    order_image.appendChild(image_inside);

    console.log(`"url('${d.data.attraction.image}')"`);

    let word_to_paid = document.createElement("div");
    word_to_paid.classList.add("word_to_paid");

    let title_word_to_paid = document.createElement("p");
    title_word_to_paid.innerHTML = "台北一日遊";
    title_word_to_paid.classList.add("title_word_to_paid");

    let order_date = document.createElement("p");
    order_date.innerHTML = `日期：${d.data.date}`;
    order_date.classList.add("information");

    let order_time = document.createElement("p");
    if (d.data.time === "morning") {
      order_time.innerHTML = `時間：早上9點到下午4點`;
    } else {
      order_time.innerHTML = `時間：下午4點到早上9點`;
    }
    order_time.classList.add("information");

    let order_price = document.createElement("p");
    order_price.innerHTML = `費用：新台幣${d.data.price}元`;
    order_price.classList.add("information");

    let order_name_attraction = document.createElement("p");
    order_name_attraction.innerHTML = `地點：${d.data.attraction.name}`;
    order_name_attraction.classList.add("information");

    word_to_paid.appendChild(order_date);
    word_to_paid.appendChild(order_time);
    word_to_paid.appendChild(order_price);
    word_to_paid.appendChild(order_name_attraction);

    let checkout = document.createElement("div");
    checkout.classList.add("checkout");
    checkout.appendChild(order_image);
    console.log(order_image);
    checkout.appendChild(word_to_paid);

    let delete_action_btn = document.createElement("img");
    delete_action_btn.src = "../static/icon_delete.png";
    delete_action_btn.classList.add("delete");

    checkout.appendChild(delete_action_btn);

    schedule.appendChild(checkout);

    document.getElementById(
      "total_sum"
    ).innerHTML = `確認總價：新台幣${d.data.price}元`;

    attraction_order = {
      price: d.data.price,
      trip: {
        attraction: d.data.attraction,
        date: d.data.date,
        time: d.data.time,
      },
    };
  }

  // <!-- <div class="checkout">
  //     <div class="photo"></div>
  //     <div class="word_to_paid">
  //       <p class="title_word_to_paid">台北一日遊1</p>
  //       <p class="information">日期：</p>
  //       <p class="information">時間：</p>
  //       <p class="information">費用：</p>
  //       <p class="information">地點：</p>
  //     </div>
  //     <img src="../static/icon_delete.png" alt="" class="delete">
  //   </div> -->

  TPDirect.setupSDK(
    20216,
    "app_9TqLsD0qcuIVWst39YRyC9Aud7VxBnGfeYQL0NZ8JMJuYs7CJwWxEbwmITCL",
    "sandbox"
  );
  // 以下提供必填 CCV 以及選填 CCV 的 Example
  // 必填 CCV Example
  var fields = {
    number: {
      // css selector
      element: "#card-number",
      placeholder: "**** **** **** ****",
    },
    expirationDate: {
      // DOM object
      element: document.getElementById("card-expiration-date"),
      placeholder: "MM / YY",
    },
    ccv: {
      element: "#card-ccv",
      placeholder: "後三碼",
    },
  };
  // 選填 CCV Example
  // var fields = {
  //   number: {
  //     // css selector
  //     element: "#card-number",
  //     placeholder: "**** **** **** ****",
  //   },
  //   expirationDate: {
  //     // DOM object
  //     element: document.getElementById("card-expiration-date"),
  //     placeholder: "MM / YY",
  //   },
  // };
  TPDirect.card.setup({
    fields: fields,
    styles: {
      // Style all elements
      input: {
        color: "gray",
      },
      // Styling ccv field
      "input.cvc": {
        // 'font-size': '16px'
      },
      // Styling expiration-date field
      "input.expiration-date": {
        // 'font-size': '16px'
      },
      // Styling card-number field
      "input.card-number": {
        // 'font-size': '16px'
      },
      // style focus state
      ":focus": {
        // 'color': 'black'
      },
      // style valid state
      ".valid": {
        color: "green",
      },
      // style invalid state
      ".invalid": {
        color: "red",
      },
      // Media queries
      // Note that these apply to the iframe, not the root window.
      "@media screen and (max-width: 400px)": {
        input: {
          color: "orange",
        },
      },
    },
  });

  function onClick() {
    TPDirect.card.getPrime(function (result) {
      if (result.status !== 0) {
        console.error("getPrime error");
      }
      let prime = result.card.prime;
      let data = {
        prime: prime,
        order: {
          price:attraction_order.price,
          trip:attraction_order.trip,
          contact: {
            name: document.getElementById("order_name").value,
            email: document.getElementById("order_email").value,
            phone: document.getElementById("order_phone").value,
          },
        },
      };
      fetch("/api/orders", {
        body: JSON.stringify(data),
        headers: {
          "content-type": "application/json",
        },
        method: "POST",
      })
        .then((res) => {
          return res.json();
        })
        .then((data) => {
          document.getElementById("status_code").innerHTML = data.data.number
        });
    });
  }
</script>
{% endblock %}